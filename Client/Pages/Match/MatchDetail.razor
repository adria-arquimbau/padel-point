@page "/match/{MatchId:guid}/detail"

@using EventsManager.Shared.Responses
@inject HttpClient Http
@inject IHttpClientFactory HttpClientFactory
@inject IToastService ToastService
@inject AuthenticationStateProvider AuthenticationStateProvider

@if (_match == null)
{
    <LoadingSpinner></LoadingSpinner>
}
else
{
    <div class="border info">
        <div>
            PADEL
        </div>
        <div>
            @_match.StartDateTime.ToLocalTime().ToLongDateString() / @_match.StartDateTime.ToLocalTime().ToShortTimeString() - @_match.EndDateTime.ToLocalTime().ToShortTimeString()
        </div>
        <div class="separation"></div>
        <div class="info-footer">
            <div class="info-footer-box">
                <div class="info-footer-box-content">
                    Gender     
                </div>
                <div class="info-footer-box-content grey-typo">
                    Not set     
                </div>
            </div>
            <div class="info-footer-box">
                <div class="info-footer-box-content">
                    Level     
                </div>
                <div class="info-footer-box-content grey-typo">
                    All
                </div>
            </div>
            <div class="info-footer-box">
                <div class="info-footer-box-content">
                    Price     
                </div>
                <div class="info-footer-box-content grey-typo">
                    -
                </div>
            </div>
        </div>
    </div>
    <div class="border match-detail-private">
        @if (_match.IsPrivate)
        {
            <div class="status">
                <i class="bi bi-lock"></i> <p> Private</p>
            </div>
        }
        else
        {
            <div class="status">
                <i class="bi bi-unlock"></i> <p> Public</p>
            </div>
        }
        <div class="separator"></div>
        <div class="creator">
            <p>Created By: Arki</p>
        </div>
    </div>
    <div class="border match-detail-players">
        <div>
            Players
        </div>
        <div class="teams">

            <div class="team">
                Team 1
                <div class="players-grid">
                    @for(var i=0; i<2; i++)
                    {
                        if (i < _match.PlayersTeamOne.Count())
                        {
                            var player = _match.PlayersTeamOne[i];
                            <div class="player">
                                @if (player.ImageUrl != null)
                                {
                                    <div class="player-avatar">
                                        <img src="@player.ImageUrl" alt="Player avatar" class="player-avatar-img">
                                        <AuthorizeView>
                                            <Authorized>
                                                <button onclick="@(() => RemovePlayer(player.Id))" class="remove-button">-</button>
                                            </Authorized>
                                        </AuthorizeView>
                                    </div>
                                }
                                else
                                {
                                    <div class="default-avatar">
                                    </div>
                                }
                                <p>@player.NickName</p>
                                <p>Skill: @player.Elo</p>
                            </div>
                        }
                        else
                        {
                            <div class="player">
                                <div class="default-avatar">
                                    <button onclick="@(() => AddPlayer("Team1"))">+</button>
                                </div>
                            </div>
                        }
                    }
                </div>
                <p style="font-size: 12px">Average Skill: @_averageEloTeamOne</p>
            </div>

            <div class="team">
                Team 2
                <div class="players-grid">
                    @for(var i=0; i<2; i++)
                    {
                        if (i < _match.PlayersTeamTwo.Count())
                        {
                            var player = _match.PlayersTeamTwo[i];
                            <div class="player">
                                @if (player.ImageUrl != null)
                                {
                                    <div class="player-avatar">
                                        <img src="@player.ImageUrl" alt="Player avatar" class="player-avatar-img">
                                        <AuthorizeView>
                                            <Authorized>
                                                <button onclick="@(() => RemovePlayer(player.Id))" class="remove-button">-</button>
                                            </Authorized>
                                        </AuthorizeView>
                                    </div>
                                }
                                else
                                {
                                    <div class="default-avatar">
                                    </div>
                                }
                                <p>@player.NickName</p>
                                <p>Skill: @player.Elo</p>
                            </div>
                        }
                        else
                        {
                            <div class="player">
                                <div class="default-avatar">
                                    <button onclick="@(() => AddPlayer("Team2"))">+</button>
                                </div>
                            </div>
                        }
                    }
                </div>
                <p style="font-size: 12px">Average Skill: @_averageEloTeamTwo</p>
            </div>
        </div>
    </div>

    <div class="border match-detail-location">
        @_match.Location                        
    </div>
}

@code {
    [Parameter]
    public Guid? MatchId { get; set; }

    private MatchResponse? _match;
    
    private decimal _averageEloTeamOne;
    private decimal _averageEloTeamTwo;

    protected override async Task OnInitializedAsync()
    {
        await GetMatch();
    }

    private async Task GetMatch()
    {
        if (MatchId.HasValue)
        {
            HttpResponseMessage? response = null;
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            if (authState.User.Identity?.IsAuthenticated == false)
            {
                var http = HttpClientFactory.CreateClient("PadelPoint.ServerAPI.Anonymous");
                response = await http.GetAsync($"match/{MatchId.Value}");
            }
            else
            {
                response = await Http.GetAsync($"match/{MatchId.Value}");
            }

            if (response.IsSuccessStatusCode)
            {
                _match = await response.Content.ReadFromJsonAsync<MatchResponse>();
                if (_match != null)
                {
                    _averageEloTeamOne = _match.PlayersTeamOne.Any()
                        ? Math.Round(_match.PlayersTeamOne.Average(mp => mp.Elo), 2) : 0;

                    _averageEloTeamTwo = _match.PlayersTeamTwo.Any()
                        ? Math.Round(_match.PlayersTeamTwo.Average(mp => mp.Elo), 2) : 0;
                }
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                ToastService.ShowError(error);
            }
        }
    }

    async Task AddPlayer(string team)
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity?.IsAuthenticated == false)
        {
            ToastService.ShowError("You must be logged in to register for this match.");
            return;
        }
        
        var response = await Http.PostAsync($"match/{MatchId!.Value}/add-me/{team}", null);

        if(response.IsSuccessStatusCode)
        {
            ToastService.ShowInfo("You have been added to the match.");
            await GetMatch();
        }
        else
        {
            var error = await response.Content.ReadAsStringAsync();
            ToastService.ShowError(error);
        }
    }
    
    async Task RemovePlayer(Guid playerId)
    {
        var response = await Http.DeleteAsync($"match/{MatchId!.Value}/remove/{playerId}");

        if(response.IsSuccessStatusCode)
        {
            ToastService.ShowInfo("You have been removed from the match.");
            await GetMatch();
            StateHasChanged();
        }
        else
        {
            var error = await response.Content.ReadAsStringAsync();
            ToastService.ShowError(error);
        }
    }

}

<style>
    .border
    {
        margin: 12px;
        padding: 12px;
        border: 2px solid grey;
        border-radius: 10px;   
        display: flex;  
        background-color: white;
    }
    
    .grey-typo
    {
        color: grey;
    }
    
    .info
    {
        flex-direction: column;
    }
    
    .info-footer
    {
        display: flex;  
        flex-direction: row;
        justify-content: space-between;
    }
    
    .info-footer-box
    {
        display: flex;  
        flex-direction: column;    
        margin: 12px;
    }
    
    .info-footer-box-content
    {
        text-align: center;
    }
    
    .match-detail-players {
      display: flex;
      flex-direction: column;
    }
    
    .separation
    {
        margin-top: 5px;
        margin-bottom: 5px;
        border: 0.5px solid grey;
    }
    
    .teams {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
    }
    
    .team {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .players-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-top: 10px;
    }
    
    .player {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 60px;
        font-size: 12px;
    }
    
    .player-avatar, .default-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    
    .player-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .default-avatar button {
        color: green;
        background: none;
        border: none;
        font-size: 30px;
        cursor: pointer;
        position: absolute;
    }
    
    .remove-button {
        position: absolute;
        top: -5px;
        right: -5px;
        width: 15px;
        height: 15px;
        border-radius: 50%;
        border: none;
        background-color: red;
        color: white;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .match-detail-private {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
    }
    
    .match-detail-private i {
        margin-right: 8px;
    }
    
    .match-detail-private p {
        margin: 0;
    }
    
    .status, .creator {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 45%;
    }
    
    .separator {
        width: 2px;
        background-color: grey;
        height: 50%;
        align-self: center;
    }
    
    .player-avatar-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .default-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: grey;
    }

</style>
