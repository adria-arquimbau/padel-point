@page "/create-match"

@using EventsManager.Shared.Requests
@using EventsManager.Shared.Responses
@inject HttpClient Http
@inject NavigationManager NavManager
@inject IToastService ToastService

@if (_loading)
{
    <LoadingSpinner></LoadingSpinner>
}

<h3>Create Match</h3>

<form id="newMatchForm" class="my-form" @onsubmit="HandleValidSubmit">
    <div class="form-group">
        <label>Select the date and starting time</label>
        <DateEdit TValue="DateTime" @bind-Date="@_start" InputMode="DateInputMode.DateTime"/>    
    </div>
    <div class="form-group">
        <label>Duration</label>
        <Select @bind-SelectedValue="@_durationSelect" TValue="int">
            <SelectItem Value="1">1 hour</SelectItem>
            <SelectItem Value="2">1,5 hours</SelectItem>
            <SelectItem Value="3">2 hours</SelectItem>
            <SelectItem Value="4">2,5 hours</SelectItem>
            <SelectItem Value="5">3 hours</SelectItem>
        </Select>
    </div>
    <div class="form-group">
        <label>Price per hour:</label>
        <NumericEdit TValue="double" @bind-Value="@_pricePerHour" />    
    </div>
    <div class="form-group">
        <Switch @bind-Checked="@_isPrivate" TValue="bool">Private match</Switch>
    </div>
    <button type="submit" class="btn btn-primary">Create Match</button>
</form>

@code {

    private DateTime _start = DateTime.Now;
    private int _durationSelect = 1;
    private double _pricePerHour;
    private bool _isPrivate;
    private bool _loading;

    private async Task HandleValidSubmit()
    {
        _loading = true;
        var durationInHours = _durationSelect switch
        {
            1 => 1,
            2 => 1.5,
            3 => 2,
            4 => 2.5,
            5 => 3,
            _ => 1
            };

        var request = new CreateMatchRequest
        {
            StartDate = _start,
            Duration = durationInHours,
            IsPrivate = _isPrivate,
            PricePerHour = _pricePerHour
        };

        try
        {
            var response = await Http.PostAsJsonAsync("match", request);
        
            if(response.IsSuccessStatusCode)
            {
                var createdMatch = await response.Content.ReadFromJsonAsync<CreateMatchResponse>();
                NavManager.NavigateTo($"/match/{createdMatch?.Id}/detail");
                ToastService.ShowSuccess("Match created successfully.");
            }
            else
            {
                ToastService.ShowError("Something went wrong. Please try again later.");
            }
        }
        catch (Exception)
        {
            ToastService.ShowError("Something went wrong. Please try again later.");
        }
        finally
        {
            _loading = false;
        }
    }
}
